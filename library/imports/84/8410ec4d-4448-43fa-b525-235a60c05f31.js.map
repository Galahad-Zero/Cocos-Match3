{"version":3,"sources":["assets\\Script\\gamePlay\\TouchHandler.ts"],"names":[],"mappings":";;;;;;;;;;;;;AAAA,2CAA2D;AAC3D,kDAAkD;AAClD,2CAAoC;AAEpC,MAAM,EAAE,OAAO,EAAE,QAAQ,EAAE,GAAG,EAAE,CAAC,UAAU,CAAC;AAE5C,IAAY,oBAGX;AAHD,WAAY,oBAAoB;IAC5B,iEAAK,CAAA;IACL,+DAAI,CAAA;AACR,CAAC,EAHW,oBAAoB,GAApB,4BAAoB,KAApB,4BAAoB,QAG/B;AASD,IAAqB,YAAY,GAAjC,MAAqB,YAAa,SAAQ,EAAE,CAAC,SAAS;IAAtD;;QAEc,WAAM,GAAY,IAAI,CAAC;QAGjC,cAAS,GAAc,IAAI,CAAC;QAE5B,eAAU,GAAY,IAAI,CAAC;QAC3B,gBAAW,GAAY,KAAK,CAAC;QAC7B,kBAAa,GAAY,KAAK,CAAC;QAC/B,cAAS,GAAY,IAAI,CAAC;IAmF9B,CAAC;IAjFa,MAAM;QACZ,IAAI,CAAC,eAAe,EAAE,CAAC;IAC3B,CAAC;IAES,eAAe;QACrB,IAAI,CAAC,MAAM,CAAC,EAAE,CAAC,EAAE,CAAC,IAAI,CAAC,SAAS,CAAC,WAAW,EAAE,IAAI,CAAC,YAAY,EAAE,IAAI,CAAC,CAAC;QACvE,IAAI,CAAC,MAAM,CAAC,EAAE,CAAC,EAAE,CAAC,IAAI,CAAC,SAAS,CAAC,UAAU,EAAE,IAAI,CAAC,WAAW,EAAE,IAAI,CAAC,CAAC;QACrE,IAAI,CAAC,MAAM,CAAC,EAAE,CAAC,EAAE,CAAC,IAAI,CAAC,SAAS,CAAC,SAAS,EAAE,IAAI,CAAC,UAAU,EAAE,IAAI,CAAC,CAAC;IACvE,CAAC;IAES,YAAY,CAAC,CAAsB;QACzC,IAAI,CAAC,IAAI,CAAC,UAAU,EAAE;YAClB,OAAO;SACV;QACD,IAAI,CAAC,WAAW,GAAG,KAAK,CAAC;QACzB,IAAI,CAAC,aAAa,GAAG,KAAK,CAAC;QAC3B,MAAM,GAAG,GAAG,IAAI,CAAC,MAAM,CAAC,oBAAoB,CAAC,CAAC,CAAC,WAAW,EAAE,CAAC,CAAC;QAC9D,IAAI,CAAC,SAAS,GAAG,GAAG,CAAC;IACzB,CAAC;IAES,WAAW,CAAC,CAAsB;QACxC,IAAI,CAAC,IAAI,CAAC,UAAU,EAAE;YAClB,OAAO;SACV;QACD,MAAM,GAAG,GAAG,IAAI,CAAC,MAAM,CAAC,oBAAoB,CAAC,CAAC,CAAC,WAAW,EAAE,CAAC,CAAC;QAC9D,MAAM,KAAK,GAAG,GAAG,CAAC,GAAG,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;QACtC,MAAM,SAAS,GAAG,IAAI,CAAC,YAAY,CAAC,KAAK,CAAC,CAAC;QAE3C,IAAI,SAAS,KAAK,qBAAS,CAAC,IAAI,EAAE;YAC9B,mBAAmB;YACnB,OAAO;SACV;QACD,IAAI,CAAC,WAAW,GAAG,IAAI,CAAC;QACxB,wDAAwD;QACxD,MAAM,QAAQ,GAAG,IAAI,CAAC,SAAS,CAAC,qBAAqB,CAAC,GAAG,CAAC,CAAC;QAC3D,SAAS;QACT,IAAI,CAAC,IAAI,CAAC,aAAa,EAAE;YACrB,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,6BAAiB,EAAE;gBAC9B,IAAI,EAAE,oBAAoB,CAAC,IAAI;gBAC/B,QAAQ;gBACR,SAAS;aACZ,CAAC,CAAC;YACH,IAAI,CAAC,aAAa,GAAG,IAAI,CAAC;SAC7B;IACL,CAAC;IAES,UAAU,CAAC,CAAsB;QACvC,IAAI,CAAC,IAAI,CAAC,UAAU,EAAE;YAClB,OAAO;SACV;QACD,IAAI,CAAC,IAAI,CAAC,WAAW,IAAI,CAAC,IAAI,CAAC,aAAa,EAAE;YAC1C,MAAM,GAAG,GAAG,IAAI,CAAC,MAAM,CAAC,oBAAoB,CAAC,CAAC,CAAC,WAAW,EAAE,CAAC,CAAC;YAC9D,MAAM,QAAQ,GAAG,IAAI,CAAC,SAAS,CAAC,qBAAqB,CAAC,GAAG,CAAC,CAAC;YAC3D,gBAAgB;YAChB,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,6BAAiB,EAAE;gBAC9B,IAAI,EAAE,oBAAoB,CAAC,KAAK;gBAChC,QAAQ,EAAE,QAAQ;aACrB,CAAC,CAAC;YACH,IAAI,CAAC,aAAa,GAAG,IAAI,CAAC;SAC7B;QACD,IAAI,CAAC,WAAW,GAAG,KAAK,CAAC;QACzB,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC;IAC1B,CAAC;IAES,YAAY,CAAC,KAAc,EAAE,YAAoB,EAAE;QACzD,MAAM,QAAQ,GAAG,KAAK,CAAC,GAAG,EAAE,CAAC;QAC7B,IAAI,QAAQ,GAAG,SAAS,EAAE;YACtB,OAAO,qBAAS,CAAC,IAAI,CAAC;SACzB;QACD,OAAO,wBAAY,CAAC,KAAK,CAAC,CAAC;IAC/B,CAAC;IAEM,UAAU,CAAC,OAAgB;QAC9B,IAAI,CAAC,UAAU,GAAG,OAAO,CAAC;IAC9B,CAAC;IAES,SAAS;QACf,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,EAAE,CAAC,IAAI,CAAC,SAAS,CAAC,WAAW,EAAE,IAAI,CAAC,YAAY,EAAE,IAAI,CAAC,CAAC;QACxE,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,EAAE,CAAC,IAAI,CAAC,SAAS,CAAC,UAAU,EAAE,IAAI,CAAC,WAAW,EAAE,IAAI,CAAC,CAAC;QACtE,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,EAAE,CAAC,IAAI,CAAC,SAAS,CAAC,SAAS,EAAE,IAAI,CAAC,UAAU,EAAE,IAAI,CAAC,CAAC;IACxE,CAAC;CACJ,CAAA;AA3FG;IADC,QAAQ,CAAC,EAAE,CAAC,IAAI,CAAC;4CACe;AAGjC;IADC,QAAQ,CAAC,mBAAS,CAAC;+CACQ;AALX,YAAY;IADhC,OAAO;GACa,YAAY,CA6FhC;kBA7FoB,YAAY","file":"","sourceRoot":"/","sourcesContent":["import { Direction, TOUCH_BLOCK_EVENT } from './GameConst';\r\nimport { getDirection } from './common/GameUtils';\r\nimport PlayPanel from './PlayPanel';\r\n\r\nconst { ccclass, property } = cc._decorator;\r\n\r\nexport enum TouchDetailEventType {\r\n    click,\r\n    drag,\r\n}\r\n\r\nexport interface TouchDetailEvent {\r\n    type: TouchDetailEventType;\r\n    location: { row: number; column: number };\r\n    direction?: Direction;\r\n}\r\n\r\n@ccclass\r\nexport default class TouchHandler extends cc.Component {\r\n    @property(cc.Node)\r\n    protected target: cc.Node = null;\r\n\r\n    @property(PlayPanel)\r\n    playPanel: PlayPanel = null;\r\n\r\n    _isEnabled: boolean = true;\r\n    _isDragging: boolean = false;\r\n    _hasEmitEvent: boolean = false;\r\n    _startPos: cc.Vec2 = null;\r\n\r\n    protected onLoad(): void {\r\n        this.initTouchEvents();\r\n    }\r\n\r\n    protected initTouchEvents(): void {\r\n        this.target.on(cc.Node.EventType.TOUCH_START, this.onTouchStart, this);\r\n        this.target.on(cc.Node.EventType.TOUCH_MOVE, this.onTouchMove, this);\r\n        this.target.on(cc.Node.EventType.TOUCH_END, this.onTouchEnd, this);\r\n    }\r\n\r\n    protected onTouchStart(e: cc.Event.EventTouch): void {\r\n        if (!this._isEnabled) {\r\n            return;\r\n        }\r\n        this._isDragging = false;\r\n        this._hasEmitEvent = false;\r\n        const pos = this.target.convertToNodeSpaceAR(e.getLocation());\r\n        this._startPos = pos;\r\n    }\r\n\r\n    protected onTouchMove(e: cc.Event.EventTouch): void {\r\n        if (!this._isEnabled) {\r\n            return;\r\n        }\r\n        const pos = this.target.convertToNodeSpaceAR(e.getLocation());\r\n        const delta = pos.sub(this._startPos);\r\n        const direction = this.getDirection(delta);\r\n\r\n        if (direction === Direction.NONE) {\r\n            // 如果方向为NONE，则不发送事件\r\n            return;\r\n        }\r\n        this._isDragging = true;\r\n        // const block = this.playPanel.getBlockByPosition(pos);\r\n        const location = this.playPanel.getLocationByPosition(pos);\r\n        // 发送拖动事件\r\n        if (!this._hasEmitEvent) {\r\n            this.node.emit(TOUCH_BLOCK_EVENT, {\r\n                type: TouchDetailEventType.drag,\r\n                location,\r\n                direction,\r\n            });\r\n            this._hasEmitEvent = true;\r\n        }\r\n    }\r\n\r\n    protected onTouchEnd(e: cc.Event.EventTouch): void {\r\n        if (!this._isEnabled) {\r\n            return;\r\n        }\r\n        if (!this._isDragging && !this._hasEmitEvent) {\r\n            const pos = this.target.convertToNodeSpaceAR(e.getLocation());\r\n            const location = this.playPanel.getLocationByPosition(pos);\r\n            // 如果未拖动，则发送点击事件\r\n            this.node.emit(TOUCH_BLOCK_EVENT, {\r\n                type: TouchDetailEventType.click,\r\n                location: location,\r\n            });\r\n            this._hasEmitEvent = true;\r\n        }\r\n        this._isDragging = false;\r\n        this._startPos = null;\r\n    }\r\n\r\n    protected getDirection(delta: cc.Vec2, threshold: number = 10): Direction {\r\n        const absDelta = delta.mag();\r\n        if (absDelta < threshold) {\r\n            return Direction.NONE;\r\n        }\r\n        return getDirection(delta);\r\n    }\r\n\r\n    public setEnabled(enabled: boolean): void {\r\n        this._isEnabled = enabled;\r\n    }\r\n\r\n    protected onDestroy(): void {\r\n        this.target.off(cc.Node.EventType.TOUCH_START, this.onTouchStart, this);\r\n        this.target.off(cc.Node.EventType.TOUCH_MOVE, this.onTouchMove, this);\r\n        this.target.off(cc.Node.EventType.TOUCH_END, this.onTouchEnd, this);\r\n    }\r\n}\r\n"]}