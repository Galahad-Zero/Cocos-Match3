{"version":3,"sources":["assets\\Script\\gamePlay\\GameMgr.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["import PlayPanel from './PlayPanel';\nimport { Direction, TOUCH_BLOCK_EVENT } from './GameConst';\nimport TouchHandler, {\n    TouchDetailEvent,\n    TouchDetailEventType,\n} from './TouchHandler';\nimport {\n    BlockConfig,\n    BlockSpecialType,\n    BlockType,\n    EliminateCheckInfo,\n    EliminateScore,\n    GameCheckInfo,\n    LevelConfig,\n    Location,\n} from './GameTypes';\nimport { getSwapLocation, isNeighborLocation } from './common/GameUtils';\nimport {\n    releaseSpecialBlock,\n    specialBlockGenerator,\n} from './common/EliminateUtils';\nimport GameUI from './ui/GameUI';\nimport EffectMgr from './effects/EffectMgr';\nimport AudioMgr from '../AudioMgr';\nimport BlockMgr from './block/BlockMgr';\nimport GameFsm, { GameState } from './common/GameFsm';\n\nconst { ccclass, property } = cc._decorator;\n\n@ccclass\nexport default class GameMgr extends cc.Component {\n    @property(PlayPanel)\n    playPanel: PlayPanel = null;\n\n    @property(GameUI)\n    gameUI: GameUI = null;\n\n    @property(TouchHandler)\n    touchHandler: TouchHandler = null;\n\n    @property(BlockMgr)\n    blockMgr: BlockMgr = null;\n\n    @property(EffectMgr)\n    effectMgr: EffectMgr = null;\n\n    @property(AudioMgr)\n    audioMgr: AudioMgr = null;\n\n    _selectedLocation: Location = null;\n\n    _gameFsm: GameFsm = null;\n    _gameCheckInfo: GameCheckInfo = null;\n\n    protected onLoad(): void {\n        this._gameFsm = new GameFsm(GameState.READY);\n        this._gameFsm.onStateChange(this.onStateChange.bind(this));\n        this.touchHandler.node.on(TOUCH_BLOCK_EVENT, this.onTouchEvent, this);\n    }\n\n    protected start(): void {\n        this.audioMgr.playMusic();\n    }\n\n    public initGamePanel(levelConfig: LevelConfig): void {\n        this.playPanel.initGamePanel(\n            levelConfig,\n            this.blockMgr,\n            this.effectMgr\n        );\n        this.gameUI.initGameUI(0, levelConfig.stepLimit);\n        // 初始化游戏面板后，转换到游玩状态\n        this._gameFsm.changeState(GameState.PLAYING);\n    }\n\n    /**\n     * 游戏状态改变回调\n     *\n     * @param fromState 当前状态\n     * @param toState 新状态\n     */\n    public onStateChange(fromState: GameState, toState: GameState): void {\n        switch (toState) {\n            case GameState.READY:\n                this.onReady();\n                break;\n            case GameState.PLAYING:\n                this.onPlaying();\n                break;\n            case GameState.CHECKING:\n                this.onChecking();\n                break;\n            case GameState.ELIMINATING:\n                this.onEliminating();\n                break;\n            case GameState.DROPPING:\n                this.onDropping();\n                break;\n            case GameState.GAME_OVER:\n                this.onGameOver();\n                break;\n            case GameState.GAME_WIN:\n                this.onGameWin();\n                break;\n        }\n    }\n\n    public onTouchEvent(event: TouchDetailEvent): void {\n        // 非玩家操作 或 没有步数\n        if (!this._gameFsm.canPlayerOperate() || !this.gameUI.haveStepCount()) {\n            return;\n        }\n        // 玩家可操作\n        const { type, location } = event;\n        if (type === TouchDetailEventType.click) {\n            this.onClickBlock(location);\n        } else if (type === TouchDetailEventType.drag) {\n            this.onDragBlock(location, event.direction || Direction.NONE);\n        }\n    }\n\n    // 点击方块\n    protected onClickBlock(location: Location): void {\n        if (!this._selectedLocation) {\n            this._selectedLocation = location;\n            return;\n        }\n        // 点击方块\n        const isSameBlock =\n            this._selectedLocation.row === location.row &&\n            this._selectedLocation.column === location.column;\n        if (isSameBlock) {\n            // 点击同一个方块，取消选中\n            this._selectedLocation = null;\n            return;\n        }\n        const isNeighbor = isNeighborLocation(this._selectedLocation, location);\n        if (isNeighbor) {\n            // 点击相邻方块，交换方块\n            this.swapBlocks(this._selectedLocation, location);\n            this._selectedLocation = null;\n        } else {\n            // 点击非相邻方块，更新选中\n            this._selectedLocation = location;\n        }\n    }\n\n    // 拖动方块\n    protected onDragBlock(location: Location, direction: Direction): void {\n        const swapLocation = getSwapLocation(location, direction);\n        if (this.playPanel.isInBounds(swapLocation)) {\n            // 以交换后的方块位置优先级更高\n            this.swapBlocks(swapLocation, location);\n        }\n        this._selectedLocation = null;\n    }\n\n    protected swapBlocks(location1: Location, location2: Location): void {\n        this._gameCheckInfo = this.generatetBaseGameCheckInfo();\n        // 交换方块\n        this._gameCheckInfo.checkBlockEntry = [location1, location2];\n        // 1. 交换方块\n        const gameMapInfo = this._gameCheckInfo.gameMapInfo;\n        const tempConfig = gameMapInfo[location2.row][location2.column];\n        gameMapInfo[location2.row][location2.column] =\n            gameMapInfo[location1.row][location1.column];\n        gameMapInfo[location1.row][location1.column] = tempConfig;\n\n        this._gameCheckInfo.swapBlocks = [location1, location2];\n        this.audioMgr.playSwapAudio();\n        // 减少步数\n        // 转换到检查消除状态\n        this._gameFsm.changeState(GameState.CHECKING);\n        // 2. 规则检查\n        // 3. 撤回 或 消除\n        // 4. 掉落 执行第 2 步\n        // 5. 结束\n    }\n\n    public onReady(): void {\n        console.log('游戏状态准备完成');\n    }\n\n    public onPlaying(): void {\n        console.log('游戏状态游玩中');\n        this._gameCheckInfo = null;\n        this.touchHandler.setEnabled(true);\n    }\n\n    public onChecking(): void {\n        // 检查消除,并标记可消除方块\n        // console.log('游戏状态检查消除');\n        this.touchHandler.setEnabled(false);\n\n        const excludeLocations = [];\n        for (const entry of this._gameCheckInfo.checkBlockEntry) {\n            const contiguousLocations = this.playPanel.getContiguousBlocks(\n                entry,\n                this._gameCheckInfo.gameMapInfo,\n                excludeLocations\n            );\n            // 如果连续方块数量大于等于3，则标记为可消除\n            if (contiguousLocations.length >= 3) {\n                // 将可消除方块加入排除列表\n                excludeLocations.push(...contiguousLocations);\n                // 将可消除方块加入可消除方块数组\n                this._gameCheckInfo.canEliminateCheckInfos.push({\n                    entryLocation: entry,\n                    eliminateBlockType: BlockSpecialType.NONE,\n                    contiguousLocations,\n                });\n            }\n        }\n        // 检查特殊炸弹方块\n        if (this._gameCheckInfo.swapBlocks) {\n            const [location1, location2] = this._gameCheckInfo.swapBlocks;\n            const blockConfig1 =\n                this._gameCheckInfo.gameMapInfo[location1.row][\n                    location1.column\n                ];\n            const blockConfig2 =\n                this._gameCheckInfo.gameMapInfo[location2.row][\n                    location2.column\n                ];\n            if (blockConfig1.special === BlockSpecialType.SPECIAL_BOOM) {\n                // 特殊炸弹方块，直接标记为可消除\n                this._gameCheckInfo.canEliminateCheckInfos.push({\n                    entryLocation: location2,\n                    eliminateBlockType: BlockSpecialType.NONE,\n                    contiguousLocations: [location1],\n                });\n            }\n            if (blockConfig2.special === BlockSpecialType.SPECIAL_BOOM) {\n                // 特殊炸弹方块，直接标记为可消除\n                this._gameCheckInfo.canEliminateCheckInfos.push({\n                    entryLocation: location1,\n                    eliminateBlockType: BlockSpecialType.NONE,\n                    contiguousLocations: [location2],\n                });\n            }\n        }\n\n        if (this._gameCheckInfo.canEliminateCheckInfos.length > 0) {\n            // 减少步数\n            this._gameCheckInfo.swapBlocks && this.gameUI.decrementStepCount();\n            // 转换到消除状态\n            this._gameFsm.changeState(GameState.ELIMINATING);\n        } else {\n            if (this._gameCheckInfo.swapBlocks) {\n                const [location1, location2] = this._gameCheckInfo.swapBlocks;\n                // 方块交换再还原\n                this.playPanel.swapAndBackBlocks(location1, location2, () => {\n                    // 没有可消除方块，方块交换再还原，转换到游玩状态\n                    this._gameFsm.changeState(GameState.PLAYING);\n                });\n            } else {\n                // 没有可消除方块 且 没有交换方块，检查游戏是否结束\n                this.checkGameOver();\n            }\n        }\n    }\n\n    public onEliminating(): void {\n        // 获取已经消除的方块\n        const alreadyEliminateBlocks: Array<Location> =\n            this._gameCheckInfo.canEliminateCheckInfos.reduce((acc, info) => {\n                return acc.concat(info.contiguousLocations);\n            }, [] as Array<Location>);\n        // 消除方块,并释放特性\n        for (const eliminateCheckInfo of this._gameCheckInfo\n            .canEliminateCheckInfos) {\n            // 生成特殊方块\n            specialBlockGenerator(eliminateCheckInfo, this._gameCheckInfo);\n            // 释放特性, 消除额外方块\n            releaseSpecialBlock(\n                eliminateCheckInfo,\n                alreadyEliminateBlocks,\n                this._gameCheckInfo\n            );\n        }\n        // 计算得分\n        let score = 0;\n        for (const eliminateCheckInfo of this._gameCheckInfo\n            .canEliminateCheckInfos) {\n            const blockCount = eliminateCheckInfo.contiguousLocations.length;\n            // 基础得分\n            score += EliminateScore.EliminateBlockScore * blockCount;\n            // 特殊得分\n            switch (eliminateCheckInfo.eliminateBlockType) {\n                case BlockSpecialType.ROW:\n                    score += EliminateScore.Base4RowScore;\n                    break;\n                case BlockSpecialType.COLUMN:\n                    score += EliminateScore.Base4ColumnScore;\n                    break;\n                case BlockSpecialType.BOOM:\n                    score += EliminateScore.Irregular5Score;\n                    break;\n                case BlockSpecialType.SPECIAL_BOOM:\n                    score += EliminateScore.Base5Score;\n                    break;\n            }\n        }\n        // 连锁加成\n        score *= this._gameCheckInfo.chainCount;\n        // 增加得分\n        this.gameUI.incrementScore(score);\n        // 消除方块,并执行动画\n        this.effectMgr.playComboAudio(this._gameCheckInfo.chainCount);\n        this.playPanel.eliminateBlocks(this._gameCheckInfo, () => {\n            this._gameFsm.changeState(GameState.DROPPING);\n        });\n        // console.log('游戏状态消除,并释放特性');\n        // this._gameFsm.changeState(GameState.DROPPING);\n    }\n\n    public onDropping(): void {\n        // 随机产生并掉落方块\n        // 1. 生成特殊方块\n        this.playPanel.generateNewSpecialBlocks(this._gameCheckInfo);\n        // 2. 掉落随机方块补齐位置\n        this.playPanel.dropRandomBlocks((entryList: Array<Location>) => {\n            const baseGameCheckInfo = this.generatetBaseGameCheckInfo();\n            baseGameCheckInfo.checkBlockEntry = entryList;\n            // 连锁次数 + 1\n            baseGameCheckInfo.chainCount = this._gameCheckInfo.chainCount + 1;\n            this._gameCheckInfo = baseGameCheckInfo;\n            console.log('drop check: ', this._gameCheckInfo);\n            this._gameFsm.changeState(GameState.CHECKING);\n        });\n    }\n\n    public onGameOver(): void {\n        // 显示游戏结束界面\n        this.gameUI.showGameOverPanel();\n        this.audioMgr.stopMusic();\n        this.touchHandler.setEnabled(false);\n    }\n\n    public onGameWin(): void {\n        // 显示过关界面\n        this.gameUI.showGameWinPanel();\n        this.audioMgr.stopMusic();\n        this.touchHandler.setEnabled(false);\n    }\n\n    /**\n     * 检查游戏是否结束\n     */\n    public checkGameOver(): void {\n        const curScore = this.gameUI.getScore();\n        const targetScore = this.playPanel.getLevelConfig().targetScore;\n        if (curScore >= targetScore) {\n            // 得分大于等于目标分数，游戏胜利\n            this._gameFsm.changeState(GameState.GAME_WIN);\n        }\n        // 检查游戏是否结束, 还有步数则继续游戏，否则游戏结束\n        else if (this.gameUI.haveStepCount()) {\n            const { chainCount } = this._gameCheckInfo;\n            this.effectMgr.playCommentAudio(chainCount - 1);\n            // 还有步数，继续游戏\n            this._gameFsm.changeState(GameState.PLAYING);\n        } else {\n            // 没有步数，游戏结束\n            this._gameFsm.changeState(GameState.GAME_OVER);\n        }\n    }\n\n    public backToLevelSelect(): void {\n        cc.director.loadScene('LevelSelect');\n    }\n\n    public generatetBaseGameCheckInfo(): GameCheckInfo {\n        // 生成基础游戏检查信息\n        const gameMapInfo = this.playPanel.getBlockMapInfo();\n        const checkBlockEntry: Location[] = [];\n        const canEliminateBlocks: Array<EliminateCheckInfo> = [];\n        const eliminateScore = 0;\n        const newSpecailBlocks: Record<string, BlockConfig> = {};\n        return {\n            gameMapInfo,\n            checkBlockEntry,\n            swapBlocks: null,\n            chainCount: 1,\n            canEliminateCheckInfos: canEliminateBlocks,\n            eliminateScore,\n            newSpecailBlocks,\n        };\n    }\n\n    protected onDestroy(): void {\n        cc.audioEngine.stopAllEffects();\n        cc.audioEngine.stopMusic();\n    }\n}\n"]}