{"version":3,"sources":["assets\\Script\\gamePlay\\GameFsm.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["/**\n * 游戏状态枚举\n * 定义游戏的所有可能状态\n */\nexport enum GameState {\n    /** 准备完成 */\n    READY = 'ready',\n    /** 游玩中 */\n    PLAYING = 'playing',\n    /** 检查消除 */\n    CHECKING = 'checking',\n    /** 消除,并释放特性 */\n    ELIMINATING = 'eliminating',\n    /** 随机产生并掉落 */\n    DROPPING = 'dropping',\n    /** 游戏结束 */\n    GAME_OVER = 'gameOver',\n    /** 过关 */\n    GAME_WIN = 'gameWin',\n}\n\n/**\n * 状态变化回调函数类型\n */\nexport type StateChangeCallback = (\n    fromState: GameState,\n    toState: GameState\n) => void;\n\n/**\n * 游戏状态机\n * 管理游戏的状态转换和状态相关的逻辑\n */\nexport default class GameFsm {\n    /** 当前状态 */\n    private _currentState: GameState;\n\n    /** 状态变化回调列表 */\n    private _stateChangeCallbacks: StateChangeCallback[] = [];\n\n    /** 状态转换规则 - 定义哪些状态可以转换到哪些状态 */\n    private _stateTransitions: Map<GameState, GameState[]>;\n\n    constructor(initialState: GameState = GameState.READY) {\n        this._currentState = initialState;\n        this._stateTransitions = new Map();\n        this._initStateTransitions();\n    }\n\n    /**\n     * 初始化状态转换规则\n     * 定义每个状态可以转换到哪些状态\n     */\n    private _initStateTransitions(): void {\n        // Ready 状态可以转换到 Playing\n        this._stateTransitions.set(GameState.READY, [GameState.PLAYING]);\n\n        // Playing 状态可以转换到 Checking、GameOver、GameWin\n        this._stateTransitions.set(GameState.PLAYING, [\n            GameState.CHECKING,\n            GameState.GAME_OVER,\n            GameState.GAME_WIN,\n        ]);\n\n        // Checking 状态可以转换到 Playing、Eliminating、GameOver、GameWin\n        this._stateTransitions.set(GameState.CHECKING, [\n            GameState.PLAYING,\n            GameState.ELIMINATING,\n            GameState.GAME_OVER,\n            GameState.GAME_WIN,\n        ]);\n\n        // Eliminating 状态可以转换到 Dropping、GameOver、GameWin\n        this._stateTransitions.set(GameState.ELIMINATING, [\n            GameState.DROPPING,\n            GameState.GAME_OVER,\n            GameState.GAME_WIN,\n        ]);\n\n        // Dropping 状态可以转换到 Checking、GameOver、GameWin\n        this._stateTransitions.set(GameState.DROPPING, [\n            GameState.CHECKING,\n            GameState.GAME_OVER,\n            GameState.GAME_WIN,\n        ]);\n\n        // GameOver 和 GameWin 是终止状态，只能转换到 Ready (重新开始)\n        this._stateTransitions.set(GameState.GAME_OVER, [GameState.READY]);\n        this._stateTransitions.set(GameState.GAME_WIN, [GameState.READY]);\n    }\n\n    /**\n     * 获取当前状态\n     */\n    public get currentState(): GameState {\n        return this._currentState;\n    }\n\n    /**\n     * 检查是否可以从当前状态转换到目标状态\n     * @param toState 目标状态\n     * @returns 是否可以转换\n     */\n    public canTransitionTo(toState: GameState): boolean {\n        const allowedStates = this._stateTransitions.get(this._currentState);\n        return allowedStates ? allowedStates.includes(toState) : false;\n    }\n\n    /**\n     * 转换到新状态\n     * @param newState 新状态\n     * @param force 是否强制转换（忽略转换规则）\n     * @returns 是否转换成功\n     */\n    public changeState(newState: GameState, force: boolean = false): boolean {\n        // 如果状态相同，不执行转换\n        if (this._currentState === newState) {\n            console.warn(`[GameFsm] 已经处于状态: ${newState}`);\n            return false;\n        }\n\n        // 检查是否允许转换\n        if (!force && !this.canTransitionTo(newState)) {\n            console.warn(\n                `[GameFsm] 无法从状态 ${this._currentState} 转换到 ${newState}`\n            );\n            return false;\n        }\n\n        const oldState = this._currentState;\n        this._currentState = newState;\n\n        console.log(`[GameFsm] 状态转换: ${oldState} -> ${newState}`);\n\n        // 触发状态变化回调\n        this._notifyStateChange(oldState, newState);\n\n        return true;\n    }\n\n    /**\n     * 注册状态变化回调\n     * @param callback 回调函数\n     */\n    public onStateChange(callback: StateChangeCallback): void {\n        if (!this._stateChangeCallbacks.includes(callback)) {\n            this._stateChangeCallbacks.push(callback);\n        }\n    }\n\n    /**\n     * 移除状态变化回调\n     * @param callback 回调函数\n     */\n    public offStateChange(callback: StateChangeCallback): void {\n        const index = this._stateChangeCallbacks.indexOf(callback);\n        if (index !== -1) {\n            this._stateChangeCallbacks.splice(index, 1);\n        }\n    }\n\n    /**\n     * 通知所有监听者状态已改变\n     * @param fromState 原状态\n     * @param toState 新状态\n     */\n    private _notifyStateChange(fromState: GameState, toState: GameState): void {\n        this._stateChangeCallbacks.forEach((callback) => {\n            try {\n                callback(fromState, toState);\n            } catch (error) {\n                console.error('[GameFsm] 状态变化回调执行错误:', error);\n            }\n        });\n    }\n\n    /**\n     * 检查是否处于某个状态\n     * @param state 要检查的状态\n     */\n    public isState(state: GameState): boolean {\n        return this._currentState === state;\n    }\n\n    /**\n     * 检查是否处于游戏进行中的状态（非结束状态）\n     */\n    public isGameActive(): boolean {\n        return (\n            this._currentState !== GameState.GAME_OVER &&\n            this._currentState !== GameState.GAME_WIN &&\n            this._currentState !== GameState.READY\n        );\n    }\n\n    /**\n     * 检查是否可以进行玩家操作\n     */\n    public canPlayerOperate(): boolean {\n        return this._currentState === GameState.PLAYING;\n    }\n\n    /**\n     * 重置状态机到初始状态\n     */\n    public reset(): void {\n        const oldState = this._currentState;\n        this._currentState = GameState.READY;\n        console.log(`[GameFsm] 状态机重置到: ${GameState.READY}`);\n        this._notifyStateChange(oldState, GameState.READY);\n    }\n\n    /**\n     * 清理状态机，移除所有回调\n     */\n    public destroy(): void {\n        this._stateChangeCallbacks = [];\n        console.log('[GameFsm] 状态机已销毁');\n    }\n}\n"]}